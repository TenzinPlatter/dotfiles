#!/bin/bash
set -e

# lookout-worktree-create - Create a git worktree with isolated venv for Lookout
#
# Usage: lookout-worktree-create <branch-name> [base-branch]
#
# Works with both existing and new branches.
# Creates a worktree in .worktrees/ with:
# - Lightweight venv using --system-site-packages (shares base dependencies)
# - Editable installs of lookout_cli and lookout_config
# - Copied secrets from main checkout
# - Auto-configured .envrc for direnv

BRANCH_NAME="$1"
BASE_BRANCH="${2:-main}"

if [ -z "$BRANCH_NAME" ]; then
    echo "Usage: lookout-worktree-create <branch-name> [base-branch]"
    echo ""
    echo "Examples:"
    echo "  lookout-worktree-create feature-xyz          # Create new branch from main"
    echo "  lookout-worktree-create hotfix-123 develop   # Create new branch from develop"
    echo "  lookout-worktree-create existing-branch      # Move existing branch to worktree"
    exit 1
fi

# Determine repo root
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

WORKTREE_PATH="$REPO_ROOT/.worktrees/$BRANCH_NAME"

if [ -d "$WORKTREE_PATH" ]; then
    echo "Error: Worktree already exists at $WORKTREE_PATH"
    exit 1
fi

echo "Creating worktree for branch '$BRANCH_NAME'..."

# Check if branch already exists
if git show-ref --verify --quiet refs/heads/"$BRANCH_NAME"; then
    echo "Branch '$BRANCH_NAME' exists, checking it out..."
    git worktree add "$WORKTREE_PATH" "$BRANCH_NAME"
else
    echo "Creating new branch '$BRANCH_NAME' from '$BASE_BRANCH'..."
    git worktree add "$WORKTREE_PATH" -b "$BRANCH_NAME" "$BASE_BRANCH"
fi

cd "$WORKTREE_PATH"

echo "Setting up Python virtual environment..."
# Use --system-site-packages to share base dependencies, saves space and time
python3 -m venv --system-site-packages ./lookout

echo "Installing editable packages..."
./lookout/bin/pip install -q -e ./tools/lookout_cli
./lookout/bin/pip install -q -e ./packages/lookout_config

# Copy secrets if they exist
if [ -d "$REPO_ROOT/.secrets" ]; then
    echo "Copying secrets..."
    cp -r "$REPO_ROOT/.secrets" ./.secrets
fi

# Create .envrc for direnv
echo "Configuring direnv..."
cat > .envrc <<'EOF'
# Auto-generated by lookout-worktree-create
# Points lookout CLI wrapper to this worktree's venv
export LOOKOUT_VENV_PATH="$(pwd)/lookout"

# Optional: Auto-activate venv when entering directory
# Uncomment if you want automatic venv activation
# source lookout/bin/activate
EOF

# Allow direnv for this directory
direnv allow .

echo ""
echo "âœ“ Worktree ready at: $WORKTREE_PATH"
echo ""
echo "To start working:"
echo "  cd $WORKTREE_PATH"
echo "  # direnv will auto-configure the environment"
echo "  lookout up"
echo ""
echo "To remove this worktree later:"
echo "  git worktree remove $WORKTREE_PATH"
