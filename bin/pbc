#!/usr/bin/env python3

import os

import argparse
import subprocess

GR_ROSDEP_LOCATION = "/home/tenzin/Repositories/rosdep/install/rosdep/bin/rosdep"


def split_on_condition(lst, condition):
    """Split list into sublists, splitting at elements where condition is
    True."""
    result = []
    current = []

    for item in lst:
        if condition(item):
            if current:  # Only add non-empty groups
                result.append(current)
                current = []
        else:
            current.append(item)

    if current:  # Don't forget the last group
        result.append(current)

    return result


def main(args):
    cwd = os.getcwd()
    platform_module = os.path.basename(cwd)

    cmd = []

    # fragile, only works for my setup
    rosdep_location = subprocess.run(["which", "rosdep"]).stdout.decode().strip()

    if rosdep_location != GR_ROSDEP_LOCATION:
        # source ros env
        cmd.extend(["sr", "&&"])

    if args.install:
        cmd.extend(["platform", "pkg", "install-deps", "&&"])

    cmd.extend(
        [
            "colcon",
            "build",
            "--merge-install",
            "--install-base",
            f'"/opt/greenroom/{platform_module}"',
            "--cmake-args",
            "-DCMAKE_EXPORT_COMPILE_COMMANDS=ON",
        ]
    )

    cmds = split_on_condition(cmd, lambda x: x == "&&")
    print("Running commands:\n")
    print("\n".join(cmds))

    subprocess.run(cmd, shell=True, check=True)

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="PBC Command Line Tool")
    parser.add_argument("-i", "--install", help="Whether to install dependencies")
    parser.add_argument("packages", nargs="*", help="List of packages to install")

    args = parser.parse_args()

    main(args)
